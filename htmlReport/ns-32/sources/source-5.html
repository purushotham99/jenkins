


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > SetupWizard</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">jenkins.install</a>
</div>

<h1>Coverage Summary for Class: SetupWizard (jenkins.install)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SetupWizard</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/288)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SetupWizard$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SetupWizard$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/302)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package jenkins.install;
&nbsp;
&nbsp;import static org.apache.commons.lang.StringUtils.defaultIfBlank;
&nbsp;
&nbsp;import edu.umd.cs.findbugs.annotations.CheckForNull;
&nbsp;import edu.umd.cs.findbugs.annotations.NonNull;
&nbsp;import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
&nbsp;import hudson.BulkChange;
&nbsp;import hudson.Extension;
&nbsp;import hudson.FilePath;
&nbsp;import hudson.ProxyConfiguration;
&nbsp;import hudson.Util;
&nbsp;import hudson.model.DownloadService;
&nbsp;import hudson.model.PageDecorator;
&nbsp;import hudson.model.UpdateCenter;
&nbsp;import hudson.model.UpdateSite;
&nbsp;import hudson.model.User;
&nbsp;import hudson.security.AccountCreationFailedException;
&nbsp;import hudson.security.FullControlOnceLoggedInAuthorizationStrategy;
&nbsp;import hudson.security.HudsonPrivateSecurityRealm;
&nbsp;import hudson.security.SecurityRealm;
&nbsp;import hudson.security.csrf.CrumbIssuer;
&nbsp;import hudson.security.csrf.GlobalCrumbIssuerConfiguration;
&nbsp;import hudson.util.FormValidation;
&nbsp;import hudson.util.HttpResponses;
&nbsp;import hudson.util.PluginServletFilter;
&nbsp;import hudson.util.VersionNumber;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.net.HttpRetryException;
&nbsp;import java.net.HttpURLConnection;
&nbsp;import java.net.URI;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLConnection;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.InvalidPathException;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.Paths;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;import java.util.logging.Level;
&nbsp;import java.util.logging.Logger;
&nbsp;import javax.servlet.Filter;
&nbsp;import javax.servlet.FilterChain;
&nbsp;import javax.servlet.FilterConfig;
&nbsp;import javax.servlet.ServletException;
&nbsp;import javax.servlet.ServletRequest;
&nbsp;import javax.servlet.ServletResponse;
&nbsp;import javax.servlet.http.HttpServletRequest;
&nbsp;import javax.servlet.http.HttpServletRequestWrapper;
&nbsp;import javax.servlet.http.HttpServletResponse;
&nbsp;import javax.servlet.http.HttpSession;
&nbsp;import jenkins.model.Jenkins;
&nbsp;import jenkins.model.JenkinsLocationConfiguration;
&nbsp;import jenkins.security.ApiTokenProperty;
&nbsp;import jenkins.security.apitoken.TokenUuidAndPlainValue;
&nbsp;import jenkins.security.seed.UserSeedProperty;
&nbsp;import jenkins.util.SystemProperties;
&nbsp;import jenkins.util.UrlHelper;
&nbsp;import net.sf.json.JSONArray;
&nbsp;import net.sf.json.JSONObject;
&nbsp;import org.apache.commons.io.IOUtils;
&nbsp;import org.kohsuke.accmod.Restricted;
&nbsp;import org.kohsuke.accmod.restrictions.DoNotUse;
&nbsp;import org.kohsuke.accmod.restrictions.NoExternalUse;
&nbsp;import org.kohsuke.stapler.HttpResponse;
&nbsp;import org.kohsuke.stapler.QueryParameter;
&nbsp;import org.kohsuke.stapler.StaplerRequest;
&nbsp;import org.kohsuke.stapler.StaplerResponse;
&nbsp;import org.kohsuke.stapler.interceptor.RequirePOST;
&nbsp;import org.kohsuke.stapler.verb.POST;
&nbsp;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.security.core.context.SecurityContextHolder;
&nbsp;import org.springframework.security.core.userdetails.UsernameNotFoundException;
&nbsp;
&nbsp;/**
&nbsp; * A Jenkins instance used during first-run to provide a limited set of services while
&nbsp; * initial installation is in progress
&nbsp; *
&nbsp; * @since 2.0
&nbsp; */
&nbsp;@Restricted(NoExternalUse.class)
&nbsp;@Extension
&nbsp;public class SetupWizard extends PageDecorator {
<b class="nc">&nbsp;    public SetupWizard() {</b>
<b class="nc">&nbsp;        checkFilter();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * The security token parameter name
&nbsp;     */
&nbsp;    @SuppressFBWarnings(value = &quot;MS_SHOULD_BE_FINAL&quot;, justification = &quot;used in several plugins&quot;)
<b class="nc">&nbsp;    public static String initialSetupAdminUserName = &quot;admin&quot;;</b>
&nbsp;
<b class="nc">&nbsp;    private static final Logger LOGGER = Logger.getLogger(SetupWizard.class.getName());</b>
&nbsp;
<b class="nc">&nbsp;    private static final String ADMIN_INITIAL_API_TOKEN_PROPERTY_NAME = SetupWizard.class.getName() + &quot;.adminInitialApiToken&quot;;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * This property determines the behavior during the SetupWizard install phase concerning the API Token creation
&nbsp;     * for the initial admin account.
&nbsp;     * The behavior depends on the provided value:
&nbsp;     * - true
&nbsp;     *      A token is generated using random value at startup and the information is put
&nbsp;     *      in the file &quot;$JENKINS_HOME/secrets/initialAdminApiToken&quot;.
&nbsp;     * - [2-char hash version][32-hex-char of secret], where the hash version is currently only 11.
&nbsp;     *      E.g. 110123456789abcdef0123456789abcdef.
&nbsp;     *      A fixed API Token will be created for the user with that plain value as the token.
&nbsp;     *      It is strongly recommended to use it to generate a new one (random) and then revoke it.
&nbsp;     *      See {@link ApiTokenProperty#generateNewToken(String)} and {@link ApiTokenProperty#revokeAllTokensExceptOne(String)}
&nbsp;     *      for scripting methods or using the web API calls:
&nbsp;     *      /user/[user-login]/descriptorByName/jenkins.security.ApiTokenProperty/generateNewToken and
&nbsp;     *      /user/[user-login]/descriptorByName/jenkins.security.ApiTokenProperty/revokeAllExcept
&nbsp;     * - @[file-location] where the file contains plain text value of the token, all stuff explained above is applicable
&nbsp;     *      The application will not delete the file after read, so the script is responsible to clean up the stuff
&nbsp;     *
&nbsp;     * When the API Token is generated using this system property, it&#39;s strongly recommended that you are revoking it
&nbsp;     * during your installation script using the other ways at your disposal so that you have a fresh token
&nbsp;     * with less traces for your script.
&nbsp;     *
&nbsp;     * If you do not provide any value to that system property, the default admin account will not have an API Token.
&nbsp;     *
&nbsp;     * @since 2.260 (with NoExternalUse)
&nbsp;     */
&nbsp;    @Restricted(NoExternalUse.class)
&nbsp;    @SuppressFBWarnings(value = &quot;MS_SHOULD_BE_FINAL&quot;, justification = &quot;Accessible via System Groovy Scripts&quot;)
<b class="nc">&nbsp;    private static /* not final */ String ADMIN_INITIAL_API_TOKEN = SystemProperties.getString(ADMIN_INITIAL_API_TOKEN_PROPERTY_NAME);</b>
&nbsp;
&nbsp;    @NonNull
&nbsp;    @Override
&nbsp;    public String getDisplayName() {
<b class="nc">&nbsp;        return Messages.SetupWizard_DisplayName();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Initialize the setup wizard, this will process any current state initializations
&nbsp;     */
&nbsp;    /*package*/ void init(boolean newInstall) throws IOException, InterruptedException {
<b class="nc">&nbsp;        Jenkins jenkins = Jenkins.get();</b>
&nbsp;
<b class="nc">&nbsp;        if (newInstall) {</b>
&nbsp;            // Create an admin user by default with a difficult password
<b class="nc">&nbsp;            FilePath iapf = getInitialAdminPasswordFile();</b>
<b class="nc">&nbsp;            if (jenkins.getSecurityRealm() == null || jenkins.getSecurityRealm() == SecurityRealm.NO_AUTHENTICATION) { // this seems very fragile</b>
<b class="nc">&nbsp;                try (BulkChange bc = new BulkChange(jenkins)) {</b>
<b class="nc">&nbsp;                    HudsonPrivateSecurityRealm securityRealm = new HudsonPrivateSecurityRealm(false, false, null);</b>
<b class="nc">&nbsp;                    jenkins.setSecurityRealm(securityRealm);</b>
<b class="nc">&nbsp;                    String randomUUID = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;).toLowerCase(Locale.ENGLISH);</b>
&nbsp;
&nbsp;                    // create an admin user
<b class="nc">&nbsp;                    User initialAdmin = securityRealm.createAccount(SetupWizard.initialSetupAdminUserName, randomUUID);</b>
&nbsp;
<b class="nc">&nbsp;                    if (ADMIN_INITIAL_API_TOKEN != null) {</b>
<b class="nc">&nbsp;                        createInitialApiToken(initialAdmin);</b>
&nbsp;                    }
&nbsp;
&nbsp;                    // JENKINS-33599 - write to a file in the jenkins home directory
&nbsp;                    // most native packages of Jenkins creates a machine user account &#39;jenkins&#39; to run Jenkins,
&nbsp;                    // and use group &#39;jenkins&#39; for admins. So we allow groups to read this file
<b class="nc">&nbsp;                    iapf.touch(System.currentTimeMillis());</b>
<b class="nc">&nbsp;                    iapf.chmod(0640);</b>
<b class="nc">&nbsp;                    iapf.write(randomUUID + System.lineSeparator(), &quot;UTF-8&quot;);</b>
&nbsp;
&nbsp;
&nbsp;                    // Lock Jenkins down:
<b class="nc">&nbsp;                    FullControlOnceLoggedInAuthorizationStrategy authStrategy = new FullControlOnceLoggedInAuthorizationStrategy();</b>
<b class="nc">&nbsp;                    authStrategy.setAllowAnonymousRead(false);</b>
<b class="nc">&nbsp;                    jenkins.setAuthorizationStrategy(authStrategy);</b>
&nbsp;
&nbsp;                    // Disable jnlp by default, but honor system properties
<b class="nc">&nbsp;                    jenkins.setSlaveAgentPort(SystemProperties.getInteger(Jenkins.class.getName() + &quot;.slaveAgentPort&quot;, -1));</b>
&nbsp;
&nbsp;                    // require a crumb issuer
<b class="nc">&nbsp;                    jenkins.setCrumbIssuer(GlobalCrumbIssuerConfiguration.createDefaultCrumbIssuer());</b>
&nbsp;
<b class="nc">&nbsp;                    jenkins.save(); // TODO could probably be removed since some of the above setters already call save</b>
<b class="nc">&nbsp;                    bc.commit();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (iapf.exists()) {</b>
<b class="nc">&nbsp;                String setupKey = iapf.readToString().trim();</b>
<b class="nc">&nbsp;                String ls = System.lineSeparator();</b>
<b class="nc">&nbsp;                LOGGER.info(ls + ls + &quot;*************************************************************&quot; + ls</b>
&nbsp;                        + &quot;*************************************************************&quot; + ls
&nbsp;                        + &quot;*************************************************************&quot; + ls
&nbsp;                        + ls
&nbsp;                        + &quot;Jenkins initial setup is required. An admin user has been created and &quot;
&nbsp;                        + &quot;a password generated.&quot; + ls
&nbsp;                        + &quot;Please use the following password to proceed to installation:&quot; + ls
&nbsp;                        + ls
&nbsp;                        + setupKey + ls
&nbsp;                        + ls
<b class="nc">&nbsp;                        + &quot;This may also be found at: &quot; + iapf.getRemote() + ls</b>
&nbsp;                        + ls
&nbsp;                        + &quot;*************************************************************&quot; + ls
&nbsp;                        + &quot;*************************************************************&quot; + ls
&nbsp;                        + &quot;*************************************************************&quot; + ls);
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        try {
&nbsp;            // Make sure plugin metadata is up to date
<b class="nc">&nbsp;            UpdateCenter.updateDefaultSite();</b>
<b class="nc">&nbsp;        } catch (RuntimeException e) {</b>
<b class="nc">&nbsp;            LOGGER.log(Level.WARNING, e.getMessage(), e);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressFBWarnings(value = &quot;UNSAFE_HASH_EQUALS&quot;, justification = &quot;only checked against true&quot;)
&nbsp;    private void createInitialApiToken(User user) throws IOException, InterruptedException {
<b class="nc">&nbsp;        ApiTokenProperty apiTokenProperty = user.getProperty(ApiTokenProperty.class);</b>
&nbsp;
<b class="nc">&nbsp;        String sysProp = ADMIN_INITIAL_API_TOKEN;</b>
<b class="nc">&nbsp;        if (sysProp.equals(&quot;true&quot;)) {</b>
<b class="nc">&nbsp;            TokenUuidAndPlainValue tokenUuidAndPlainValue = apiTokenProperty.generateNewToken(&quot;random-generation-during-setup-wizard&quot;);</b>
<b class="nc">&nbsp;            FilePath fp = getInitialAdminApiTokenFile();</b>
&nbsp;            // same comment as in the init method
&nbsp;
&nbsp;            // JENKINS-33599 - write to a file in the jenkins home directory
&nbsp;            // most native packages of Jenkins creates a machine user account &#39;jenkins&#39; to run Jenkins,
&nbsp;            // and use group &#39;jenkins&#39; for admins. So we allow groups to read this file
<b class="nc">&nbsp;            fp.touch(System.currentTimeMillis());</b>
<b class="nc">&nbsp;            fp.chmod(0640);</b>
<b class="nc">&nbsp;            fp.write(tokenUuidAndPlainValue.plainValue, StandardCharsets.UTF_8.name());</b>
<b class="nc">&nbsp;            LOGGER.log(Level.INFO, &quot;The API Token was randomly generated and the information was put in {0}&quot;, fp.getRemote());</b>
<b class="nc">&nbsp;        } else {</b>
&nbsp;            String plainText;
<b class="nc">&nbsp;            if (sysProp.startsWith(&quot;@&quot;)) {</b>
&nbsp;                // no need for path traversal check as it&#39;s coming from the instance creator only
<b class="nc">&nbsp;                String apiTokenStr = sysProp.substring(1);</b>
&nbsp;                Path apiTokenFile;
&nbsp;                try {
<b class="nc">&nbsp;                    apiTokenFile = Paths.get(apiTokenStr);</b>
<b class="nc">&nbsp;                } catch (InvalidPathException e) {</b>
<b class="nc">&nbsp;                    LOGGER.log(Level.WARNING, &quot;The API Token cannot be retrieved from an invalid path: {0}&quot;, apiTokenStr);</b>
&nbsp;                    return;
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (!Files.exists(apiTokenFile)) {</b>
<b class="nc">&nbsp;                    LOGGER.log(Level.WARNING, &quot;The API Token cannot be retrieved from a non-existing file: {0}&quot;, apiTokenFile);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    plainText = Files.readString(apiTokenFile, StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;                    LOGGER.log(Level.INFO, &quot;API Token generated using contents of file: {0}&quot;, apiTokenFile.toAbsolutePath());</b>
<b class="nc">&nbsp;                } catch (IOException e) {</b>
<b class="nc">&nbsp;                    LOGGER.log(Level.WARNING, String.format(&quot;The API Token cannot be retrieved from the file: %s&quot;, apiTokenFile), e);</b>
&nbsp;                    return;
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.INFO, &quot;API Token generated using system property: {0}&quot;, ADMIN_INITIAL_API_TOKEN_PROPERTY_NAME);</b>
<b class="nc">&nbsp;                plainText = sysProp;</b>
&nbsp;            }
&nbsp;
&nbsp;            try {
<b class="nc">&nbsp;                apiTokenProperty.addFixedNewToken(&quot;fix-generation-during-setup-wizard&quot;, plainText);</b>
&nbsp;            }
<b class="nc">&nbsp;            catch (IllegalArgumentException e) {</b>
<b class="nc">&nbsp;                String constraintFailureMessage = e.getMessage();</b>
<b class="nc">&nbsp;                LOGGER.log(Level.WARNING, &quot;The API Token cannot be generated using the provided value due to: {0}&quot;, constraintFailureMessage);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setUpFilter() {
&nbsp;        try {
<b class="nc">&nbsp;            if (!PluginServletFilter.hasFilter(FORCE_SETUP_WIZARD_FILTER)) {</b>
<b class="nc">&nbsp;                PluginServletFilter.addFilter(FORCE_SETUP_WIZARD_FILTER);</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (ServletException e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Unable to add PluginServletFilter for the SetupWizard&quot;, e);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void tearDownFilter() {
&nbsp;        try {
<b class="nc">&nbsp;            if (PluginServletFilter.hasFilter(FORCE_SETUP_WIZARD_FILTER)) {</b>
<b class="nc">&nbsp;                PluginServletFilter.removeFilter(FORCE_SETUP_WIZARD_FILTER);</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (ServletException e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Unable to remove PluginServletFilter for the SetupWizard&quot;, e);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Indicates a generated password should be used - e.g. this is a new install, no security realm set up
&nbsp;     */
&nbsp;    @SuppressWarnings(&quot;unused&quot;) // used by jelly
&nbsp;    public boolean isUsingSecurityToken() {
&nbsp;        try {
<b class="nc">&nbsp;            return !Jenkins.get().getInstallState().isSetupComplete()</b>
<b class="nc">&nbsp;                    &amp;&amp; isUsingSecurityDefaults();</b>
<b class="nc">&nbsp;        } catch (RuntimeException e) {</b>
&nbsp;            // ignore
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determines if the security settings seem to match the defaults. Here, we only
&nbsp;     * really care about and test for HudsonPrivateSecurityRealm and the user setup.
&nbsp;     * Other settings are irrelevant.
&nbsp;     */
&nbsp;    /*package*/ boolean isUsingSecurityDefaults() {
<b class="nc">&nbsp;        Jenkins j = Jenkins.get();</b>
<b class="nc">&nbsp;        if (j.getSecurityRealm() instanceof HudsonPrivateSecurityRealm) {</b>
<b class="nc">&nbsp;            HudsonPrivateSecurityRealm securityRealm = (HudsonPrivateSecurityRealm) j.getSecurityRealm();</b>
&nbsp;            try {
<b class="nc">&nbsp;                if (securityRealm.getAllUsers().size() == 1) {</b>
<b class="nc">&nbsp;                    HudsonPrivateSecurityRealm.Details details = securityRealm.load(SetupWizard.initialSetupAdminUserName);</b>
<b class="nc">&nbsp;                    FilePath iapf = getInitialAdminPasswordFile();</b>
<b class="nc">&nbsp;                    if (iapf.exists()) {</b>
<b class="nc">&nbsp;                        if (details.isPasswordCorrect(iapf.readToString().trim())) {</b>
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } catch (UsernameNotFoundException | IOException | InterruptedException e) {</b>
<b class="nc">&nbsp;                return false; // Not initial security setup if no transitional admin user / password found</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called during the initial setup to create an admin user
&nbsp;     */
&nbsp;    @POST
&nbsp;    @Restricted(NoExternalUse.class)
&nbsp;    public HttpResponse doCreateAdminUser(StaplerRequest req, StaplerResponse rsp) throws IOException {
<b class="nc">&nbsp;        Jenkins j = Jenkins.get();</b>
&nbsp;
<b class="nc">&nbsp;        j.checkPermission(Jenkins.ADMINISTER);</b>
&nbsp;
&nbsp;        // This will be set up by default. if not, something changed, ok to fail
<b class="nc">&nbsp;        HudsonPrivateSecurityRealm securityRealm = (HudsonPrivateSecurityRealm) j.getSecurityRealm();</b>
&nbsp;
<b class="nc">&nbsp;        User admin = securityRealm.getUser(SetupWizard.initialSetupAdminUserName);</b>
&nbsp;        try {
<b class="nc">&nbsp;            ApiTokenProperty initialApiTokenProperty = null;</b>
&nbsp;
<b class="nc">&nbsp;            if (admin != null) {</b>
<b class="nc">&nbsp;                initialApiTokenProperty = admin.getProperty(ApiTokenProperty.class);</b>
<b class="nc">&nbsp;                admin.delete(); // assume the new user may well be &#39;admin&#39;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            User newUser = securityRealm.createAccountFromSetupWizard(req);</b>
<b class="nc">&nbsp;            if (admin != null) {</b>
<b class="nc">&nbsp;                admin = null;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (initialApiTokenProperty != null) {</b>
&nbsp;                // actually it will remove the current one and replace it with the one from initial admin
<b class="nc">&nbsp;                newUser.addProperty(initialApiTokenProperty);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Success! Delete the temporary password file:
&nbsp;            try {
<b class="nc">&nbsp;                getInitialAdminPasswordFile().delete();</b>
<b class="nc">&nbsp;            } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;                throw new IOException(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;            try {
<b class="nc">&nbsp;                FilePath fp = getInitialAdminApiTokenFile();</b>
&nbsp;                // no care about TOCTOU as it&#39;s done during instance creation process only (i.e. not yet user reachable)
<b class="nc">&nbsp;                if (fp.exists()) {</b>
<b class="nc">&nbsp;                    fp.delete();</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;                throw new IOException(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            InstallUtil.proceedToNextStateFrom(InstallState.CREATE_ADMIN_USER);</b>
&nbsp;
&nbsp;            // ... and then login
<b class="nc">&nbsp;            Authentication auth = new UsernamePasswordAuthenticationToken(newUser.getId(), req.getParameter(&quot;password1&quot;));</b>
<b class="nc">&nbsp;            auth = securityRealm.getSecurityComponents().manager2.authenticate(auth);</b>
<b class="nc">&nbsp;            SecurityContextHolder.getContext().setAuthentication(auth);</b>
&nbsp;
<b class="nc">&nbsp;            HttpSession session = req.getSession(false);</b>
<b class="nc">&nbsp;            if (session != null) {</b>
&nbsp;                // avoid session fixation
<b class="nc">&nbsp;                session.invalidate();</b>
&nbsp;            }
<b class="nc">&nbsp;            HttpSession newSession = req.getSession(true);</b>
&nbsp;
<b class="nc">&nbsp;            UserSeedProperty userSeed = newUser.getProperty(UserSeedProperty.class);</b>
<b class="nc">&nbsp;            String sessionSeed = userSeed.getSeed();</b>
&nbsp;            // include the new seed
<b class="nc">&nbsp;            newSession.setAttribute(UserSeedProperty.USER_SESSION_SEED, sessionSeed);</b>
&nbsp;
<b class="nc">&nbsp;            CrumbIssuer crumbIssuer = Jenkins.get().getCrumbIssuer();</b>
<b class="nc">&nbsp;            JSONObject data = new JSONObject();</b>
<b class="nc">&nbsp;            if (crumbIssuer != null) {</b>
<b class="nc">&nbsp;                data.accumulate(&quot;crumbRequestField&quot;, crumbIssuer.getCrumbRequestField()).accumulate(&quot;crumb&quot;, crumbIssuer.getCrumb(req));</b>
&nbsp;            }
<b class="nc">&nbsp;            return HttpResponses.okJSON(data);</b>
<b class="nc">&nbsp;        } catch (AccountCreationFailedException e) {</b>
&nbsp;            /*
&nbsp;            Return Unprocessable Entity from WebDAV. While this is not technically in the HTTP/1.1 standard, browsers
&nbsp;            seem to accept this. 400 Bad Request is technically inappropriate because that implies invalid *syntax*,
&nbsp;            not incorrect data. The client only cares about it being &gt;200 anyways.
&nbsp;             */
<b class="nc">&nbsp;            rsp.setStatus(422);</b>
<b class="nc">&nbsp;            return HttpResponses.forwardToView(securityRealm, &quot;/jenkins/install/SetupWizard/setupWizardFirstUser.jelly&quot;);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            if (admin != null) {</b>
<b class="nc">&nbsp;                admin.save(); // recreate this initial user if something failed</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @POST
&nbsp;    @Restricted(NoExternalUse.class)
&nbsp;    public HttpResponse doConfigureInstance(StaplerRequest req, @QueryParameter String rootUrl) {
<b class="nc">&nbsp;        Jenkins.get().checkPermission(Jenkins.ADMINISTER);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();</b>
&nbsp;        // pre-check data
<b class="nc">&nbsp;        checkRootUrl(errors, rootUrl);</b>
&nbsp;
<b class="nc">&nbsp;        if (!errors.isEmpty()) {</b>
<b class="nc">&nbsp;            return HttpResponses.errorJSON(Messages.SetupWizard_ConfigureInstance_ValidationErrors(), errors);</b>
&nbsp;        }
&nbsp;
&nbsp;        // use the parameters to configure the instance
<b class="nc">&nbsp;        useRootUrl(errors, rootUrl);</b>
&nbsp;
<b class="nc">&nbsp;        if (!errors.isEmpty()) {</b>
<b class="nc">&nbsp;            return HttpResponses.errorJSON(Messages.SetupWizard_ConfigureInstance_ValidationErrors(), errors);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        InstallUtil.proceedToNextStateFrom(InstallState.CONFIGURE_INSTANCE);</b>
&nbsp;
<b class="nc">&nbsp;        CrumbIssuer crumbIssuer = Jenkins.get().getCrumbIssuer();</b>
<b class="nc">&nbsp;        JSONObject data = new JSONObject();</b>
<b class="nc">&nbsp;        if (crumbIssuer != null) {</b>
<b class="nc">&nbsp;            data.accumulate(&quot;crumbRequestField&quot;, crumbIssuer.getCrumbRequestField()).accumulate(&quot;crumb&quot;, crumbIssuer.getCrumb(req));</b>
&nbsp;        }
<b class="nc">&nbsp;        return HttpResponses.okJSON(data);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void checkRootUrl(Map&lt;String, String&gt; errors, @CheckForNull String rootUrl) {
<b class="nc">&nbsp;        if (rootUrl == null) {</b>
<b class="nc">&nbsp;            errors.put(&quot;rootUrl&quot;, Messages.SetupWizard_ConfigureInstance_RootUrl_Empty());</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (!UrlHelper.isValidRootUrl(rootUrl)) {</b>
<b class="nc">&nbsp;            errors.put(&quot;rootUrl&quot;, Messages.SetupWizard_ConfigureInstance_RootUrl_Invalid());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void useRootUrl(Map&lt;String, String&gt; errors, @CheckForNull String rootUrl) {
<b class="nc">&nbsp;        LOGGER.log(Level.FINE, &quot;Root URL set during SetupWizard to {0}&quot;, new Object[]{ rootUrl });</b>
<b class="nc">&nbsp;        JenkinsLocationConfiguration.getOrDie().setUrl(rootUrl);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*package*/ void setCurrentLevel(VersionNumber v) throws IOException {
<b class="nc">&nbsp;        Files.writeString(Util.fileToPath(getUpdateStateFile()), v.toString(), StandardCharsets.UTF_8);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * File that captures the state of upgrade.
&nbsp;     *
&nbsp;     * This file records the version number that the installation has upgraded to.
&nbsp;     */
&nbsp;    /*package*/ static File getUpdateStateFile() {
<b class="nc">&nbsp;        return new File(Jenkins.get().getRootDir(), &quot;jenkins.install.UpgradeWizard.state&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * What is the version the upgrade wizard has run the last time and upgraded to?.
&nbsp;     * If {@link #getUpdateStateFile()} is missing, presumes the baseline is 1.0
&nbsp;     * @return Current baseline. {@code null} if it cannot be retrieved.
&nbsp;     */
&nbsp;    @Restricted(NoExternalUse.class)
&nbsp;    @CheckForNull
&nbsp;    public VersionNumber getCurrentLevel() {
<b class="nc">&nbsp;        VersionNumber from = new VersionNumber(&quot;1.0&quot;);</b>
<b class="nc">&nbsp;        File state = getUpdateStateFile();</b>
<b class="nc">&nbsp;        if (state.exists()) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                from = new VersionNumber(defaultIfBlank(Files.readString(Util.fileToPath(state), StandardCharsets.UTF_8), &quot;1.0&quot;).trim());</b>
<b class="nc">&nbsp;            } catch (IOException ex) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.SEVERE, &quot;Cannot read the current version file&quot;, ex);</b>
<b class="nc">&nbsp;                return null;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        return from;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the initial plugin list in JSON format
&nbsp;     */
&nbsp;    @Restricted(DoNotUse.class) // WebOnly
&nbsp;    public HttpResponse doPlatformPluginList() throws IOException {
<b class="nc">&nbsp;        SetupWizard setupWizard = Jenkins.get().getSetupWizard();</b>
<b class="nc">&nbsp;        if (setupWizard != null) {</b>
<b class="nc">&nbsp;            if (InstallState.UPGRADE.equals(Jenkins.get().getInstallState())) {</b>
<b class="nc">&nbsp;                JSONArray initialPluginData = getPlatformPluginUpdates();</b>
<b class="nc">&nbsp;                if (initialPluginData != null) {</b>
<b class="nc">&nbsp;                    return HttpResponses.okJSON(initialPluginData);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                JSONArray initialPluginData = getPlatformPluginList();</b>
<b class="nc">&nbsp;                if (initialPluginData != null) {</b>
<b class="nc">&nbsp;                    return HttpResponses.okJSON(initialPluginData);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return HttpResponses.okJSON();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns whether the system needs a restart, and if it is supported
&nbsp;     * e.g. { restartRequired: true, restartSupported: false }
&nbsp;     */
&nbsp;    @Restricted(DoNotUse.class) // WebOnly
&nbsp;    public HttpResponse doRestartStatus() throws IOException {
<b class="nc">&nbsp;        JSONObject response = new JSONObject();</b>
<b class="nc">&nbsp;        Jenkins jenkins = Jenkins.get();</b>
<b class="nc">&nbsp;        response.put(&quot;restartRequired&quot;, jenkins.getUpdateCenter().isRestartRequiredForCompletion());</b>
<b class="nc">&nbsp;        response.put(&quot;restartSupported&quot;, jenkins.getLifecycle().canRestart());</b>
<b class="nc">&nbsp;        return HttpResponses.okJSON(response);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Provides the list of platform plugin updates from the last time
&nbsp;     * the upgrade was run.
&nbsp;     * @return {@code null} if the version range cannot be retrieved.
&nbsp;     */
&nbsp;    @CheckForNull
&nbsp;    public JSONArray getPlatformPluginUpdates() {
<b class="nc">&nbsp;        final VersionNumber version = getCurrentLevel();</b>
<b class="nc">&nbsp;        if (version == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        return getPlatformPluginsForUpdate(version, Jenkins.getVersion());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets the suggested plugin list from the update sites, falling back to a local version
&nbsp;     * @return JSON array with the categorized plugin list
&nbsp;     */
&nbsp;    @CheckForNull
&nbsp;    /*package*/ JSONArray getPlatformPluginList() {
<b class="nc">&nbsp;        Jenkins.get().checkPermission(Jenkins.ADMINISTER);</b>
<b class="nc">&nbsp;        JSONArray initialPluginList = null;</b>
<b class="nc">&nbsp;        updateSiteList: for (UpdateSite updateSite : Jenkins.get().getUpdateCenter().getSiteList()) {</b>
<b class="nc">&nbsp;            String suggestedPluginUrl = updateSite.getSuggestedPluginsUrl();</b>
<b class="nc">&nbsp;            VersionNumber version = Jenkins.getVersion();</b>
<b class="nc">&nbsp;            if (version != null &amp;&amp; (suggestedPluginUrl.startsWith(&quot;https://&quot;) || suggestedPluginUrl.startsWith(&quot;http://&quot;))) {</b>
&nbsp;                // Allow remote update site to distinguish based on the current version
&nbsp;                // This looks a bit hacky but UpdateCenter#toUpdateCenterCheckUrl does something similar
<b class="nc">&nbsp;                suggestedPluginUrl = suggestedPluginUrl + (suggestedPluginUrl.contains(&quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;) + &quot;version=&quot; + version;</b>
&nbsp;            }
&nbsp;            try {
<b class="nc">&nbsp;                URLConnection connection = ProxyConfiguration.open(new URI(suggestedPluginUrl).toURL());</b>
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    String initialPluginJson = IOUtils.toString(connection.getInputStream(), StandardCharsets.UTF_8);</b>
&nbsp;
<b class="nc">&nbsp;                    JSONObject initialPluginObject = null;</b>
&nbsp;
<b class="nc">&nbsp;                    if (connection instanceof HttpURLConnection) {</b>
<b class="nc">&nbsp;                        int responseCode = ((HttpURLConnection) connection).getResponseCode();</b>
<b class="nc">&nbsp;                        if (HttpURLConnection.HTTP_OK != responseCode) {</b>
<b class="nc">&nbsp;                            throw new HttpRetryException(&quot;Invalid response code (&quot; + responseCode + &quot;) from URL: &quot; + suggestedPluginUrl, responseCode);</b>
&nbsp;                        }
&nbsp;
<b class="nc">&nbsp;                        if (DownloadService.signatureCheck) {</b>
&nbsp;                            /* If the platform-plugins.json file was obtained remotely, assume that it&#39;s a JSONObject and perform a signature check on it */
<b class="nc">&nbsp;                            initialPluginObject = JSONObject.fromObject(initialPluginJson);</b>
<b class="nc">&nbsp;                            final FormValidation result = updateSite.verifySignatureInternal(initialPluginObject);</b>
<b class="nc">&nbsp;                            if (result.kind != FormValidation.Kind.OK) {</b>
<b class="nc">&nbsp;                                LOGGER.log(Level.WARNING, &quot;Ignoring remote platform-plugins.json: &quot; + result.getMessage());</b>
<b class="nc">&nbsp;                                throw result;</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    /*
&nbsp;                        The initial version of this code expected platform-plugins.json to be an array.
&nbsp;                        This structure does not work when we want to add a signature block, so a wrapper object is also supported.
&nbsp;                        In that case, the original array is expected to be in the &#39;categories&#39; key.
&nbsp;                     */
<b class="nc">&nbsp;                    if (initialPluginObject != null) {</b>
<b class="nc">&nbsp;                        initialPluginList = initialPluginObject.getJSONArray(&quot;categories&quot;);</b>
&nbsp;                    } else {
&nbsp;                        try {
<b class="nc">&nbsp;                            initialPluginList = JSONArray.fromObject(initialPluginJson);</b>
<b class="nc">&nbsp;                        } catch (RuntimeException ex) {</b>
&nbsp;                            /* Second attempt: It&#39;s not a remote file, but still wrapped */
<b class="nc">&nbsp;                            initialPluginList = JSONObject.fromObject(initialPluginJson).getJSONArray(&quot;categories&quot;);</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
<b class="nc">&nbsp;                    break updateSiteList;</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
&nbsp;                    // not found or otherwise unavailable
<b class="nc">&nbsp;                    LOGGER.log(Level.FINE, e.getMessage(), e);</b>
<b class="nc">&nbsp;                    continue updateSiteList;</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (Exception e) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.FINE, e.getMessage(), e);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (initialPluginList == null) {</b>
&nbsp;            // fall back to local file
&nbsp;            try {
<b class="nc">&nbsp;                ClassLoader cl = getClass().getClassLoader();</b>
<b class="nc">&nbsp;                URL localPluginData = cl.getResource(&quot;jenkins/install/platform-plugins.json&quot;);</b>
<b class="nc">&nbsp;                String initialPluginJson = IOUtils.toString(localPluginData.openStream(), StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;                initialPluginList =  JSONArray.fromObject(initialPluginJson);</b>
<b class="nc">&nbsp;            } catch (Exception e) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.SEVERE, e.getMessage(), e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        return initialPluginList;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the platform plugins added in the version range
&nbsp;     */
&nbsp;    /*package*/ JSONArray getPlatformPluginsForUpdate(VersionNumber from, VersionNumber to) {
<b class="nc">&nbsp;        Jenkins jenkins = Jenkins.get();</b>
<b class="nc">&nbsp;        JSONArray pluginCategories = JSONArray.fromObject(getPlatformPluginList().toString());</b>
<b class="nc">&nbsp;        for (Iterator&lt;?&gt; categoryIterator = pluginCategories.iterator(); categoryIterator.hasNext();) {</b>
<b class="nc">&nbsp;            Object category = categoryIterator.next();</b>
<b class="nc">&nbsp;            if (category instanceof JSONObject) {</b>
<b class="nc">&nbsp;                JSONObject cat = (JSONObject) category;</b>
<b class="nc">&nbsp;                JSONArray plugins = cat.getJSONArray(&quot;plugins&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                nextPlugin: for (Iterator&lt;?&gt; pluginIterator = plugins.iterator(); pluginIterator.hasNext();) {</b>
<b class="nc">&nbsp;                    Object pluginData = pluginIterator.next();</b>
<b class="nc">&nbsp;                    if (pluginData instanceof JSONObject) {</b>
<b class="nc">&nbsp;                        JSONObject plugin = (JSONObject) pluginData;</b>
<b class="nc">&nbsp;                        if (plugin.has(&quot;added&quot;)) {</b>
<b class="nc">&nbsp;                            String sinceVersion = plugin.getString(&quot;added&quot;);</b>
<b class="nc">&nbsp;                            if (sinceVersion != null) {</b>
<b class="nc">&nbsp;                                VersionNumber v = new VersionNumber(sinceVersion);</b>
<b class="nc">&nbsp;                                if (v.compareTo(to) &lt;= 0 &amp;&amp; v.compareTo(from) &gt; 0) {</b>
&nbsp;                                    // This plugin is valid, we&#39;ll leave &quot;suggested&quot; state
&nbsp;                                    // to match the experience during install
&nbsp;                                    // but only add it if it&#39;s currently uninstalled
<b class="nc">&nbsp;                                    String pluginName = plugin.getString(&quot;name&quot;);</b>
<b class="nc">&nbsp;                                    if (null == jenkins.getPluginManager().getPlugin(pluginName)) {</b>
&nbsp;                                        // Also check that a compatible version exists in an update site
<b class="nc">&nbsp;                                        boolean foundCompatibleVersion = false;</b>
<b class="nc">&nbsp;                                        for (UpdateSite site : jenkins.getUpdateCenter().getSiteList()) {</b>
<b class="nc">&nbsp;                                            UpdateSite.Plugin sitePlug = site.getPlugin(pluginName);</b>
<b class="nc">&nbsp;                                            if (sitePlug != null</b>
<b class="nc">&nbsp;                                                    &amp;&amp; !sitePlug.isForNewerHudson()</b>
<b class="nc">&nbsp;                                                    &amp;&amp; !sitePlug.isNeededDependenciesForNewerJenkins()) {</b>
<b class="nc">&nbsp;                                                foundCompatibleVersion = true;</b>
<b class="nc">&nbsp;                                                break;</b>
&nbsp;                                            }
<b class="nc">&nbsp;                                        }</b>
<b class="nc">&nbsp;                                        if (foundCompatibleVersion) {</b>
<b class="nc">&nbsp;                                            continue nextPlugin;</b>
&nbsp;                                        }
&nbsp;                                    }
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    pluginIterator.remove();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
<b class="nc">&nbsp;                if (plugins.isEmpty()) {</b>
<b class="nc">&nbsp;                    categoryIterator.remove();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return pluginCategories;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets the file used to store the initial admin password
&nbsp;     */
&nbsp;    public FilePath getInitialAdminPasswordFile() {
<b class="nc">&nbsp;        return Jenkins.get().getRootPath().child(&quot;secrets/initialAdminPassword&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets the file used to store the initial admin API Token, in case the system property
&nbsp;     * {@link #ADMIN_INITIAL_API_TOKEN} is set to &quot;true&quot; (and only in this case).
&nbsp;     */
&nbsp;    @Restricted(NoExternalUse.class)
&nbsp;    public FilePath getInitialAdminApiTokenFile() {
<b class="nc">&nbsp;        return Jenkins.get().getRootPath().child(&quot;secrets/initialAdminApiToken&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Remove the setupWizard filter, ensure all updates are written to disk, etc
&nbsp;     */
&nbsp;    @RequirePOST
&nbsp;    public HttpResponse doCompleteInstall() throws IOException, ServletException {
<b class="nc">&nbsp;        completeSetup();</b>
<b class="nc">&nbsp;        return HttpResponses.okJSON();</b>
&nbsp;    }
&nbsp;
&nbsp;    /*package*/ void completeSetup() throws IOException, ServletException {
<b class="nc">&nbsp;        Jenkins.get().checkPermission(Jenkins.ADMINISTER);</b>
<b class="nc">&nbsp;        InstallUtil.saveLastExecVersion();</b>
<b class="nc">&nbsp;        setCurrentLevel(Jenkins.getVersion());</b>
<b class="nc">&nbsp;        InstallUtil.proceedToNextStateFrom(InstallState.INITIAL_SETUP_COMPLETED);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gets all the install states
&nbsp;     */
&nbsp;    public List&lt;InstallState&gt; getInstallStates() {
<b class="nc">&nbsp;        return InstallState.all();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns an installState by name
&nbsp;     */
&nbsp;    public InstallState getInstallState(String name) {
<b class="nc">&nbsp;        if (name == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        return InstallState.valueOf(name);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called upon install state update.
&nbsp;     * @param state the new install state.
&nbsp;     * @since 2.94
&nbsp;     */
&nbsp;    public void onInstallStateUpdate(InstallState state) {
<b class="nc">&nbsp;        if (state.isSetupComplete()) {</b>
<b class="nc">&nbsp;            tearDownFilter();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setUpFilter();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns whether the setup wizard filter is currently registered.
&nbsp;     * @since 2.94
&nbsp;     */
&nbsp;    public boolean hasSetupWizardFilter() {
<b class="nc">&nbsp;        return PluginServletFilter.hasFilter(FORCE_SETUP_WIZARD_FILTER);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This filter will validate that the security token is provided
&nbsp;     */
<b class="nc">&nbsp;    private final Filter FORCE_SETUP_WIZARD_FILTER = new Filter() {</b>
&nbsp;        @Override
&nbsp;        public void init(FilterConfig cfg) throws ServletException {
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        @Override
&nbsp;        @SuppressFBWarnings(value = &quot;UNVALIDATED_REDIRECT&quot;, justification = &quot;TODO needs triage&quot;)
&nbsp;        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
&nbsp;            // Force root requests to the setup wizard
<b class="nc">&nbsp;            if (request instanceof HttpServletRequest &amp;&amp; !Jenkins.get().getInstallState().isSetupComplete()) {</b>
<b class="nc">&nbsp;                HttpServletRequest req = (HttpServletRequest) request;</b>
<b class="nc">&nbsp;                String requestURI = req.getRequestURI();</b>
<b class="nc">&nbsp;                if (requestURI.equals(req.getContextPath()) &amp;&amp; !requestURI.endsWith(&quot;/&quot;)) {</b>
<b class="nc">&nbsp;                    ((HttpServletResponse) response).sendRedirect(req.getContextPath() + &quot;/&quot;);</b>
&nbsp;                    return;
<b class="nc">&nbsp;                } else if (req.getRequestURI().equals(req.getContextPath() + &quot;/&quot;)) {</b>
<b class="nc">&nbsp;                    Jenkins.get().checkPermission(Jenkins.ADMINISTER);</b>
<b class="nc">&nbsp;                    chain.doFilter(new HttpServletRequestWrapper(req) {</b>
&nbsp;                        @Override
&nbsp;                        public String getRequestURI() {
<b class="nc">&nbsp;                            return getContextPath() + &quot;/setupWizard/&quot;;</b>
&nbsp;                        }
&nbsp;                    }, response);
&nbsp;                    return;
&nbsp;                }
&nbsp;                // fall through to handling the request normally
&nbsp;            }
<b class="nc">&nbsp;            chain.doFilter(request, response);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void destroy() {
<b class="nc">&nbsp;        }</b>
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the Setup Wizard filter if the current state requires it.
&nbsp;     */
&nbsp;    private void checkFilter() {
<b class="nc">&nbsp;        if (!Jenkins.get().getInstallState().isSetupComplete()) {</b>
<b class="nc">&nbsp;            setUpFilter();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-02-28 17:37</div>
</div>
</body>
</html>
