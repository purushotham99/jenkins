


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > WebAppMain</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">hudson</a>
</div>

<h1>Coverage Summary for Class: WebAppMain (hudson)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WebAppMain</td>
<td class="coverageStat">
  <span class="percent">
    30%
  </span>
  <span class="absValue">
    (3/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    5.4%
  </span>
  <span class="absValue">
    (6/111)
  </span>
</td>
</tr>
  <tr>
    <td class="name">WebAppMain$1</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    33.3%
  </span>
  <span class="absValue">
    (1/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebAppMain$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebAppMain$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebAppMain$FileAndDescription</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WebAppMain$JenkinsJVMAccess</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    21.1%
  </span>
  <span class="absValue">
    (4/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    4.6%
  </span>
  <span class="absValue">
    (7/151)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * The MIT License
&nbsp; *
&nbsp; * Copyright (c) 2004-2009, Sun Microsystems, Inc., Kohsuke Kawaguchi, Jean-Baptiste Quenot, Tom Huybrechts
&nbsp; *
&nbsp; * Permission is hereby granted, free of charge, to any person obtaining a copy
&nbsp; * of this software and associated documentation files (the &quot;Software&quot;), to deal
&nbsp; * in the Software without restriction, including without limitation the rights
&nbsp; * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
&nbsp; * copies of the Software, and to permit persons to whom the Software is
&nbsp; * furnished to do so, subject to the following conditions:
&nbsp; *
&nbsp; * The above copyright notice and this permission notice shall be included in
&nbsp; * all copies or substantial portions of the Software.
&nbsp; *
&nbsp; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
&nbsp; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
&nbsp; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
&nbsp; * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
&nbsp; * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
&nbsp; * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
&nbsp; * THE SOFTWARE.
&nbsp; */
&nbsp;
&nbsp;package hudson;
&nbsp;
&nbsp;import static java.util.logging.Level.FINE;
&nbsp;import static java.util.logging.Level.SEVERE;
&nbsp;import static java.util.logging.Level.WARNING;
&nbsp;
&nbsp;import com.thoughtworks.xstream.converters.reflection.PureJavaReflectionProvider;
&nbsp;import com.thoughtworks.xstream.core.JVM;
&nbsp;import hudson.model.Hudson;
&nbsp;import hudson.security.ACL;
&nbsp;import hudson.security.ACLContext;
&nbsp;import hudson.util.AWTProblem;
&nbsp;import hudson.util.BootFailure;
&nbsp;import hudson.util.ChartUtil;
&nbsp;import hudson.util.HudsonFailedToLoad;
&nbsp;import hudson.util.HudsonIsLoading;
&nbsp;import hudson.util.IncompatibleAntVersionDetected;
&nbsp;import hudson.util.IncompatibleServletVersionDetected;
&nbsp;import hudson.util.IncompatibleVMDetected;
&nbsp;import hudson.util.InsufficientPermissionDetected;
&nbsp;import hudson.util.NoHomeDir;
&nbsp;import hudson.util.NoTempDir;
&nbsp;import hudson.util.RingBufferLogHandler;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.io.OutputStream;
&nbsp;import java.lang.reflect.InvocationTargetException;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLClassLoader;
&nbsp;import java.nio.charset.Charset;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.InvalidPathException;
&nbsp;import java.nio.file.StandardOpenOption;
&nbsp;import java.security.Security;
&nbsp;import java.util.Date;
&nbsp;import java.util.EnumSet;
&nbsp;import java.util.Locale;
&nbsp;import java.util.logging.ConsoleHandler;
&nbsp;import java.util.logging.Formatter;
&nbsp;import java.util.logging.Handler;
&nbsp;import java.util.logging.Level;
&nbsp;import java.util.logging.LogRecord;
&nbsp;import java.util.logging.Logger;
&nbsp;import javax.servlet.ServletContext;
&nbsp;import javax.servlet.ServletContextEvent;
&nbsp;import javax.servlet.ServletContextListener;
&nbsp;import javax.servlet.ServletResponse;
&nbsp;import javax.servlet.SessionTrackingMode;
&nbsp;import jenkins.model.Jenkins;
&nbsp;import jenkins.util.JenkinsJVM;
&nbsp;import jenkins.util.SystemProperties;
&nbsp;import org.apache.tools.ant.types.FileSet;
&nbsp;import org.jvnet.localizer.LocaleProvider;
&nbsp;import org.kohsuke.accmod.Restricted;
&nbsp;import org.kohsuke.accmod.restrictions.NoExternalUse;
&nbsp;import org.kohsuke.stapler.jelly.JellyFacet;
&nbsp;
&nbsp;/**
&nbsp; * Entry point when Hudson is used as a webapp.
&nbsp; *
&nbsp; * @author Kohsuke Kawaguchi
&nbsp; */
<b class="fc">&nbsp;public class WebAppMain implements ServletContextListener {</b>
&nbsp;
&nbsp;    /**
&nbsp;     * System property name to force the session tracking by cookie.
&nbsp;     * This prevents Tomcat to use the URL tracking in addition to the cookie by default.
&nbsp;     * This could be useful for instances that requires to have
&nbsp;     * the {@link jenkins.security.SuspiciousRequestFilter#allowSemicolonsInPath} turned off.
&nbsp;     * &lt;p&gt;
&nbsp;     * If you allow semicolon in URL and the session to be tracked by URL and you have
&nbsp;     * a SecurityRealm that does not invalidate session after authentication,
&nbsp;     * your instance is vulnerable to session hijacking.
&nbsp;     * &lt;p&gt;
&nbsp;     * The SecurityRealm should be corrected but this is a hardening in Jenkins core.
&nbsp;     * &lt;p&gt;
&nbsp;     * As this property is read during startup, you will not be able to change it at runtime
&nbsp;     * depending on your application server (not possible with Jetty nor Tomcat)
&nbsp;     * &lt;p&gt;
&nbsp;     * When running hpi:run, the default tracking is COOKIE+URL.
&nbsp;     * When running java -jar with Winstone/Jetty, the default setting is set to COOKIE only.
&nbsp;     * When running inside Tomcat, the default setting is COOKIE+URL.
&nbsp;     */
&nbsp;    @Restricted(NoExternalUse.class)
<b class="fc">&nbsp;    public static final String FORCE_SESSION_TRACKING_BY_COOKIE_PROP = WebAppMain.class.getName() + &quot;.forceSessionTrackingByCookie&quot;;</b>
&nbsp;
<b class="fc">&nbsp;    private final RingBufferLogHandler handler = new RingBufferLogHandler(WebAppMain.getDefaultRingBufferSize()) {</b>
&nbsp;
&nbsp;        @Override public synchronized void publish(LogRecord record) {
<b class="nc">&nbsp;            if (record.getLevel().intValue() &gt;= Level.INFO.intValue()) {</b>
<b class="nc">&nbsp;                super.publish(record);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * This getter returns the int DEFAULT_RING_BUFFER_SIZE from the class RingBufferLogHandler from a static context.
&nbsp;     * Exposes access from RingBufferLogHandler.DEFAULT_RING_BUFFER_SIZE to WebAppMain.
&nbsp;     * Written for the requirements of JENKINS-50669
&nbsp;     * @return int This returns DEFAULT_RING_BUFFER_SIZE
&nbsp;     * @see &lt;a href=&quot;https://issues.jenkins.io/browse/JENKINS-50669&quot;&gt;JENKINS-50669&lt;/a&gt;
&nbsp;     * @since 2.259
&nbsp;     */
&nbsp;    public static int getDefaultRingBufferSize() {
<b class="fc">&nbsp;        return RingBufferLogHandler.getDefaultRingBufferSize();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static final String APP = &quot;app&quot;;
&nbsp;    private boolean terminated;
&nbsp;    private Thread initThread;
&nbsp;
&nbsp;    /**
&nbsp;     * Creates the sole instance of {@link jenkins.model.Jenkins} and register it to the {@link ServletContext}.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void contextInitialized(ServletContextEvent event) {
&nbsp;        // Nicer console log formatting when using mvn jetty:run.
<b class="nc">&nbsp;        if (Main.isDevelopmentMode &amp;&amp; System.getProperty(&quot;java.util.logging.config.file&quot;) == null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                Formatter formatter = (Formatter) Class.forName(&quot;io.jenkins.lib.support_log_formatter.SupportLogFormatter&quot;).getDeclaredConstructor().newInstance();</b>
<b class="nc">&nbsp;                for (Handler h : Logger.getLogger(&quot;&quot;).getHandlers()) {</b>
<b class="nc">&nbsp;                    if (h instanceof ConsoleHandler) {</b>
<b class="nc">&nbsp;                        h.setFormatter(formatter);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } catch (ClassNotFoundException x) {</b>
&nbsp;                // ignore
<b class="nc">&nbsp;            } catch (Exception x) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.WARNING, null, x);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        JenkinsJVMAccess._setJenkinsJVM(true);</b>
<b class="nc">&nbsp;        final ServletContext context = event.getServletContext();</b>
<b class="nc">&nbsp;        File home = null;</b>
&nbsp;        try {
&nbsp;
&nbsp;            // use the current request to determine the language
<b class="nc">&nbsp;            LocaleProvider.setProvider(new LocaleProvider() {</b>
&nbsp;                @Override
&nbsp;                public Locale get() {
<b class="nc">&nbsp;                    return Functions.getCurrentLocale();</b>
&nbsp;                }
&nbsp;            });
&nbsp;
&nbsp;            // quick check to see if we (seem to) have enough permissions to run. (see JENKINS-719)
&nbsp;            JVM jvm;
&nbsp;            try {
<b class="nc">&nbsp;                jvm = new JVM();</b>
<b class="nc">&nbsp;                new URLClassLoader(new URL[0], getClass().getClassLoader());</b>
<b class="nc">&nbsp;            } catch (SecurityException e) {</b>
<b class="nc">&nbsp;                throw new InsufficientPermissionDetected(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            try { // remove Sun PKCS11 provider if present. See http://wiki.jenkins-ci.org/display/JENKINS/Solaris+Issue+6276483
<b class="nc">&nbsp;                Security.removeProvider(&quot;SunPKCS11-Solaris&quot;);</b>
<b class="nc">&nbsp;            } catch (SecurityException e) {</b>
&nbsp;                // ignore this error.
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            installLogger();</b>
&nbsp;
<b class="nc">&nbsp;            final FileAndDescription describedHomeDir = getHomeDir(event);</b>
<b class="nc">&nbsp;            home = describedHomeDir.file.getAbsoluteFile();</b>
&nbsp;            try {
<b class="nc">&nbsp;                Util.createDirectories(home.toPath());</b>
<b class="nc">&nbsp;            } catch (IOException | InvalidPathException e) {</b>
<b class="nc">&nbsp;                throw (NoHomeDir) new NoHomeDir(home).initCause(e);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            LOGGER.info(&quot;Jenkins home directory: &quot; + home + &quot; found at: &quot; + describedHomeDir.description);</b>
&nbsp;
<b class="nc">&nbsp;            recordBootAttempt(home);</b>
&nbsp;
&nbsp;            // make sure that we are using XStream in the &quot;enhanced&quot; (JVM-specific) mode
<b class="nc">&nbsp;            if (jvm.bestReflectionProvider().getClass() == PureJavaReflectionProvider.class) {</b>
<b class="nc">&nbsp;                throw new IncompatibleVMDetected(); // nope</b>
&nbsp;            }
&nbsp;
&nbsp;            // make sure this is servlet 2.4 container or above
&nbsp;            try {
<b class="nc">&nbsp;                ServletResponse.class.getMethod(&quot;setCharacterEncoding&quot;, String.class);</b>
<b class="nc">&nbsp;            } catch (NoSuchMethodException e) {</b>
<b class="nc">&nbsp;                throw (IncompatibleServletVersionDetected) new IncompatibleServletVersionDetected(ServletResponse.class).initCause(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // make sure that we see Ant 1.7
&nbsp;            try {
<b class="nc">&nbsp;                FileSet.class.getMethod(&quot;getDirectoryScanner&quot;);</b>
<b class="nc">&nbsp;            } catch (NoSuchMethodException e) {</b>
<b class="nc">&nbsp;                throw (IncompatibleAntVersionDetected) new IncompatibleAntVersionDetected(FileSet.class).initCause(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // make sure AWT is functioning, or else JFreeChart won&#39;t even load.
<b class="nc">&nbsp;            if (ChartUtil.awtProblemCause != null) {</b>
<b class="nc">&nbsp;                throw new AWTProblem(ChartUtil.awtProblemCause);</b>
&nbsp;            }
&nbsp;
&nbsp;            // some containers (in particular Tomcat) doesn&#39;t abort a launch
&nbsp;            // even if the temp directory doesn&#39;t exist.
&nbsp;            // check that and report an error
&nbsp;            try {
<b class="nc">&nbsp;                File f = File.createTempFile(&quot;test&quot;, &quot;test&quot;);</b>
<b class="nc">&nbsp;                boolean result = f.delete();</b>
<b class="nc">&nbsp;                if (!result) {</b>
<b class="nc">&nbsp;                    LOGGER.log(FINE, &quot;Temp file test.test could not be deleted.&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (IOException e) {</b>
<b class="nc">&nbsp;                throw new NoTempDir(e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            installExpressionFactory(event);</b>
&nbsp;
<b class="nc">&nbsp;            context.setAttribute(APP, new HudsonIsLoading());</b>
<b class="nc">&nbsp;            if (SystemProperties.getBoolean(FORCE_SESSION_TRACKING_BY_COOKIE_PROP, true)) {</b>
<b class="nc">&nbsp;                context.setSessionTrackingModes(EnumSet.of(SessionTrackingMode.COOKIE));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            final File _home = home;</b>
<b class="nc">&nbsp;            initThread = new Thread(&quot;Jenkins initialization thread&quot;) {</b>
&nbsp;                @Override
&nbsp;                public void run() {
<b class="nc">&nbsp;                    boolean success = false;</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        Jenkins instance = new Hudson(_home, context);</b>
&nbsp;
&nbsp;                        // one last check to make sure everything is in order before we go live
<b class="nc">&nbsp;                        if (Thread.interrupted())</b>
<b class="nc">&nbsp;                            throw new InterruptedException();</b>
&nbsp;
<b class="nc">&nbsp;                        context.setAttribute(APP, instance);</b>
&nbsp;
<b class="nc">&nbsp;                        Files.deleteIfExists(BootFailure.getBootFailureFile(_home).toPath());</b>
&nbsp;
&nbsp;                        // at this point we are open for business and serving requests normally
<b class="nc">&nbsp;                        Jenkins.get().getLifecycle().onReady();</b>
<b class="nc">&nbsp;                        success = true;</b>
<b class="nc">&nbsp;                    } catch (Error e) {</b>
<b class="nc">&nbsp;                        new HudsonFailedToLoad(e).publish(context, _home);</b>
<b class="nc">&nbsp;                        throw e;</b>
<b class="nc">&nbsp;                    } catch (Exception e) {</b>
&nbsp;                        // Allow plugins to override error page on boot with custom BootFailure subclass thrown
<b class="nc">&nbsp;                        Throwable error = unwrapException(e);</b>
<b class="nc">&nbsp;                        if (error instanceof InvocationTargetException) {</b>
<b class="nc">&nbsp;                            Throwable targetException = ((InvocationTargetException) error).getTargetException();</b>
&nbsp;
<b class="nc">&nbsp;                            if (targetException instanceof BootFailure) {</b>
<b class="nc">&nbsp;                                ((BootFailure) targetException).publish(context, _home);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                new HudsonFailedToLoad(e).publish(context, _home);</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else {</b>
<b class="nc">&nbsp;                            new HudsonFailedToLoad(e).publish(context, _home);</b>
&nbsp;                        }
&nbsp;                    } finally {
<b class="nc">&nbsp;                        Jenkins instance = Jenkins.getInstanceOrNull();</b>
<b class="nc">&nbsp;                        if (!success &amp;&amp; instance != null)</b>
<b class="nc">&nbsp;                            instance.cleanUp();</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;
&nbsp;                private Throwable unwrapException(Exception e) {
<b class="nc">&nbsp;                    Throwable error = e;</b>
<b class="nc">&nbsp;                    while (error.getCause() != null) {</b>
<b class="nc">&nbsp;                        if (error.getCause() instanceof InvocationTargetException) {</b>
<b class="nc">&nbsp;                            return error.getCause();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        error = error.getCause();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return error;</b>
&nbsp;                }
&nbsp;            };
<b class="nc">&nbsp;            initThread.start();</b>
<b class="nc">&nbsp;        } catch (BootFailure e) {</b>
<b class="nc">&nbsp;            e.publish(context, home);</b>
<b class="nc">&nbsp;        } catch (Error | RuntimeException e) {</b>
<b class="nc">&nbsp;            LOGGER.log(SEVERE, &quot;Failed to initialize Jenkins&quot;, e);</b>
<b class="nc">&nbsp;            throw e;</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void joinInit() throws InterruptedException {
<b class="nc">&nbsp;        initThread.join();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * To assist boot failure script, record the number of boot attempts.
&nbsp;     * This file gets deleted in case of successful boot.
&nbsp;     *
&nbsp;     * @see BootFailure
&nbsp;     */
&nbsp;    private void recordBootAttempt(File home) {
<b class="nc">&nbsp;        try (OutputStream o = Files.newOutputStream(BootFailure.getBootFailureFile(home).toPath(), StandardOpenOption.CREATE, StandardOpenOption.APPEND)) {</b>
<b class="nc">&nbsp;            o.write((new Date() + System.getProperty(&quot;line.separator&quot;, &quot;\n&quot;)).getBytes(Charset.defaultCharset()));</b>
<b class="nc">&nbsp;        } catch (IOException | InvalidPathException e) {</b>
<b class="nc">&nbsp;            LOGGER.log(WARNING, &quot;Failed to record boot attempts&quot;, e);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public static void installExpressionFactory(ServletContextEvent event) {
<b class="nc">&nbsp;        JellyFacet.setExpressionFactory(event, new ExpressionFactory2());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Installs log handler to monitor all Hudson logs.
&nbsp;     */
&nbsp;    private void installLogger() {
<b class="nc">&nbsp;        Jenkins.logRecords = handler.getView();</b>
<b class="nc">&nbsp;        Logger.getLogger(&quot;&quot;).addHandler(handler);</b>
&nbsp;    }
&nbsp;
&nbsp;    /** Add some metadata to a File, allowing to trace setup issues */
&nbsp;    public static class FileAndDescription {
&nbsp;        public final File file;
&nbsp;        public final String description;
&nbsp;
<b class="nc">&nbsp;        public FileAndDescription(File file, String description) {</b>
<b class="nc">&nbsp;            this.file = file;</b>
<b class="nc">&nbsp;            this.description = description;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determines the home directory for Jenkins.
&nbsp;     *
&nbsp;     * &lt;p&gt;We look for a setting that affects the smallest scope first, then bigger ones later.
&nbsp;     *
&nbsp;     * &lt;p&gt;People make configuration mistakes, so we are trying to be nice
&nbsp;     * with those by doing {@link String#trim()}.
&nbsp;     *
&nbsp;     * @return the File alongside with some description to help the user troubleshoot issues
&nbsp;     */
&nbsp;    public FileAndDescription getHomeDir(ServletContextEvent event) {
&nbsp;        // check the system property for the home directory first
<b class="nc">&nbsp;        for (String name : HOME_NAMES) {</b>
<b class="nc">&nbsp;            String sysProp = SystemProperties.getString(name);</b>
<b class="nc">&nbsp;            if (sysProp != null)</b>
<b class="nc">&nbsp;                return new FileAndDescription(new File(sysProp.trim()), &quot;SystemProperties.getProperty(\&quot;&quot; + name + &quot;\&quot;)&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // look at the env var next
<b class="nc">&nbsp;        for (String name : HOME_NAMES) {</b>
<b class="nc">&nbsp;            String env = EnvVars.masterEnvVars.get(name);</b>
<b class="nc">&nbsp;            if (env != null)</b>
<b class="nc">&nbsp;                return new FileAndDescription(new File(env.trim()).getAbsoluteFile(), &quot;EnvVars.masterEnvVars.get(\&quot;&quot; + name + &quot;\&quot;)&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // otherwise pick a place by ourselves
&nbsp;
<b class="nc">&nbsp;        String root = event.getServletContext().getRealPath(&quot;/WEB-INF/workspace&quot;);</b>
<b class="nc">&nbsp;        if (root != null) {</b>
<b class="nc">&nbsp;            File ws = new File(root.trim());</b>
<b class="nc">&nbsp;            if (ws.exists())</b>
&nbsp;                // Hudson &lt;1.42 used to prefer this before ~/.hudson, so
&nbsp;                // check the existence and if it&#39;s there, use it.
&nbsp;                // otherwise if this is a new installation, prefer ~/.hudson
<b class="nc">&nbsp;                return new FileAndDescription(ws, &quot;getServletContext().getRealPath(\&quot;/WEB-INF/workspace\&quot;)&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        File legacyHome = new File(new File(System.getProperty(&quot;user.home&quot;)), &quot;.hudson&quot;);</b>
<b class="nc">&nbsp;        if (legacyHome.exists()) {</b>
<b class="nc">&nbsp;            return new FileAndDescription(legacyHome, &quot;$user.home/.hudson&quot;); // before rename, this is where it was stored</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        File newHome = new File(new File(System.getProperty(&quot;user.home&quot;)), &quot;.jenkins&quot;);</b>
<b class="nc">&nbsp;        return new FileAndDescription(newHome, &quot;$user.home/.jenkins&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void contextDestroyed(ServletContextEvent event) {
<b class="nc">&nbsp;        try (ACLContext old = ACL.as2(ACL.SYSTEM2)) {</b>
<b class="nc">&nbsp;            Jenkins instance = Jenkins.getInstanceOrNull();</b>
&nbsp;            try {
<b class="nc">&nbsp;                if (instance != null) {</b>
<b class="nc">&nbsp;                    instance.cleanUp();</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (Throwable e) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.SEVERE, &quot;Failed to clean up. Restart will continue.&quot;, e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            terminated = true;</b>
<b class="nc">&nbsp;            Thread t = initThread;</b>
<b class="nc">&nbsp;            if (t != null &amp;&amp; t.isAlive()) {</b>
<b class="nc">&nbsp;                LOGGER.log(Level.INFO, &quot;Shutting down a Jenkins instance that was still starting up&quot;, new Throwable(&quot;reason&quot;));</b>
<b class="nc">&nbsp;                t.interrupt();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Logger is in the system classloader, so if we don&#39;t do this
&nbsp;            // the whole web app will never be undeployed.
<b class="nc">&nbsp;            Logger.getLogger(&quot;&quot;).removeHandler(handler);</b>
<b class="nc">&nbsp;        } finally {</b>
<b class="nc">&nbsp;            JenkinsJVMAccess._setJenkinsJVM(false);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private static final Logger LOGGER = Logger.getLogger(WebAppMain.class.getName());</b>
&nbsp;
&nbsp;    private static final class JenkinsJVMAccess extends JenkinsJVM {
&nbsp;        private static void _setJenkinsJVM(boolean jenkinsJVM) {
<b class="nc">&nbsp;            JenkinsJVM.setJenkinsJVM(jenkinsJVM);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private static final String[] HOME_NAMES = {&quot;JENKINS_HOME&quot;, &quot;HUDSON_HOME&quot;};</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-02-28 17:37</div>
</div>
</body>
</html>
